{% extends "includes/base.html" %}

{% block content %}
  <header>
    <h2>Hello, {{ name }}.</h2>
    <div class="accent"></div>

    {% if watchers.is_empty() %}
      <p>You don't have any watchers configured for your account.</p>
    {% else %}
      <p>You have <strong>{{ watchers.len() }}</strong> {% if watchers.len() == 1 %}watcher{% else %}watchers{% endif %} configured. Tracks will be transferred every {{ crate::CONFIG.sync.interval_mins }} minutes.</p>
    {% endif %}
  </header>

  <div class="sections">
    <section>
      <h3>Create watcher</h3>
      <form action="/watchers" method="post" class="items">
        <div class="item">
          <label for="from_playlist">From playlist</label>
          <select name="from_playlist" id="from_playlist" onchange="playlistUpdated()">
            <option value="{{ crate::model::playlist::LIKED_PLAYLIST_VALUE }}" selected>{{ crate::model::playlist::PlaylistType::Saved.to_string() }}</option>

            {% for playlist in playlists %}
              <option value="{{ playlist.id }}">{{ playlist.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="item">
          <label for="to_playlist">To playlist</label>
          <select name="to_playlist" id="to_playlist" onchange="playlistUpdated()">
            <option value="" disabled selected hidden>Select a playlist...</option>

            {% for playlist in playlists %}
              <option value="{{ playlist.id }}">{{ playlist.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="item checkbox">
          <input type="checkbox" name="should_remove" id="should_remove" checked>
          <label for="should_remove">After syncing, remove transferred tracks from original playlist</label>
        </div>

        <button id="submit" class="button" disabled>Create watcher</button>
      </form>
    </section>

    {% if !watchers.is_empty() %}
      <section>
        <h3>Your watchers</h3>
        <div class="items">
          {% for watcher in watchers %}
            {% let (from_name, to_name) = Self::get_playlist_names(self, watcher) %}
            <div class="item">
              <h4>{{ from_name }} &rarr; {{ to_name }}</h4>
              <small>Tracks will {% if !watcher.should_remove %}<strong>not</strong>{% endif %} be removed after syncing.</small>
              <div class="split">
                <form action="/watchers/{{ watcher.id }}/sync" method="post">
                  <button class="button sm">Sync now</button>
                </form>
                <form action="/watchers/{{ watcher.id }}/delete" method="post">
                  <button class="button sm">Remove</button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}

    <section>
      <h3>Account</h3>
      <small>Click the link below to delete your account and your watchers. You can always re-connect later if you change your mind.</small>
      <form action="/me/delete" method="post" onsubmit="return confirm('Are you sure? All your data, including Your account and watchers will be deleted. You can always re-connect later.');">
        <button class="link sm">Delete your account</button>
      </form>
    </section>
  </div>
{% endblock content %}

{% block script %}
  <script>
    function playlistUpdated(e) {
      const from = document.querySelector('#from_playlist').value;
      const to = document.querySelector('#to_playlist').value;
      document.querySelector('#submit').disabled = !from || !to || from === to;
    }
  </script>
{% endblock script %}
