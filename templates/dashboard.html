{% extends "includes/base.html" %}

{% macro header_section() %}
  <section>
    <header>
      <svg width="125" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 426 90">
        <rect width="90" height="90" rx="20" fill="#1DB954" />
        <path d="M33.009 30.85V22.5h8.51v9.897l6.962 1.16v-8.119h8.51v9.665L72 37.732v9.046l-54-9.51v-9.046l15.009 2.628ZM72 52.733v9.046L56.991 59.15v8.35h-8.51v-9.897l-6.962-1.16v8.119h-8.51v-9.665L18 52.268v-9.046l54 9.51Z" fill="#fff" />
        <path d="M114 64.202V29.894h7.871v5.053h.463c.529-1.596 1.278-2.97 2.248-4.123 1.015-1.152 2.426-1.728 4.233-1.728 3.307 0 5.336 1.95 6.085 5.85h.397c.265-.797.595-1.55.992-2.26.397-.71.882-1.33 1.455-1.861a6.404 6.404 0 0 1 2.051-1.264c.793-.31 1.719-.465 2.777-.465 4.763 0 7.144 3.524 7.144 10.572v24.534h-7.871V40.665c0-1.596-.287-2.704-.86-3.325-.529-.665-1.234-.997-2.116-.997-.838 0-1.566.288-2.183.864-.573.532-.86 1.375-.86 2.527v24.468h-7.937V40.665c0-1.596-.264-2.704-.793-3.325-.485-.665-1.169-.997-2.051-.997-.881 0-1.631.288-2.248.864-.618.532-.926 1.375-.926 2.527v24.468H114ZM171.516 65c-2.646 0-5.027-.399-7.143-1.197-2.117-.842-3.924-2.039-5.424-3.59-1.455-1.552-2.579-3.435-3.373-5.652-.793-2.216-1.19-4.72-1.19-7.513s.397-5.297 1.19-7.513c.794-2.217 1.918-4.1 3.373-5.652 1.5-1.551 3.307-2.726 5.424-3.524 2.116-.842 4.497-1.263 7.143-1.263s5.027.42 7.143 1.263c2.117.798 3.902 1.973 5.357 3.524 1.5 1.551 2.646 3.435 3.44 5.652.793 2.216 1.19 4.72 1.19 7.513 0 2.792-.397 5.297-1.19 7.513-.794 2.217-1.94 4.1-3.44 5.652-1.455 1.551-3.24 2.748-5.357 3.59-2.116.798-4.497 1.197-7.143 1.197Zm0-7.314c2.205 0 3.924-.687 5.159-2.061 1.235-1.374 1.852-3.325 1.852-5.851v-5.452c0-2.527-.617-4.477-1.852-5.851-1.235-1.374-2.954-2.061-5.159-2.061-2.205 0-3.924.687-5.159 2.06-1.235 1.375-1.852 3.325-1.852 5.852v5.452c0 2.526.617 4.477 1.852 5.851 1.235 1.374 2.954 2.061 5.159 2.061ZM217.325 57.952h-.463c-.882 2.084-2.116 3.79-3.704 5.12-1.543 1.285-3.681 1.928-6.415 1.928-1.896 0-3.638-.355-5.225-1.064-1.544-.709-2.888-1.795-4.035-3.258-1.102-1.463-1.984-3.324-2.645-5.585-.618-2.26-.926-4.942-.926-8.045 0-3.103.308-5.785.926-8.045.661-2.261 1.543-4.123 2.645-5.585 1.147-1.463 2.491-2.55 4.035-3.258 1.587-.71 3.329-1.064 5.225-1.064 1.367 0 2.579.177 3.637.532 1.059.354 1.985.842 2.778 1.462a8.591 8.591 0 0 1 2.117 2.261 14.333 14.333 0 0 1 1.587 2.793h.463V15h9.789v49.202h-9.789v-6.25Zm-6.349-.598c1.719 0 3.196-.421 4.431-1.264 1.279-.842 1.918-2.172 1.918-3.989V41.995c0-1.818-.639-3.148-1.918-3.99-1.235-.842-2.712-1.263-4.431-1.263-2.205 0-3.903.687-5.093 2.061-1.191 1.33-1.786 3.192-1.786 5.585v5.32c0 2.393.595 4.277 1.786 5.651 1.19 1.33 2.888 1.995 5.093 1.995ZM256.587 57.952h-.397c-.75 1.95-1.94 3.613-3.572 4.987-1.587 1.374-3.748 2.061-6.482 2.061-1.631 0-3.13-.266-4.497-.798a9.504 9.504 0 0 1-3.506-2.526c-.97-1.109-1.741-2.46-2.314-4.056-.53-1.596-.794-3.436-.794-5.519V29.894h9.789V50.77c0 4.433 1.918 6.65 5.754 6.65.749 0 1.477-.09 2.182-.267.75-.221 1.389-.532 1.918-.93a5.31 5.31 0 0 0 1.389-1.596c.353-.62.53-1.352.53-2.194v-22.54h9.788v34.308h-9.788v-6.25ZM275.146 56.556h10.45v-33.91h-10.45V15h20.239v41.556h10.45v7.646h-30.689v-7.646ZM342.517 64.202c-2.028 0-3.66-.51-4.895-1.53-1.234-1.063-1.962-2.57-2.182-4.52h-.331c-.617 2.26-1.852 3.967-3.704 5.12-1.807 1.152-4.034 1.728-6.68 1.728-3.307 0-5.974-.886-8.003-2.66-1.984-1.817-2.976-4.344-2.976-7.58 0-3.59 1.301-6.25 3.902-7.978 2.602-1.729 6.416-2.593 11.442-2.593h5.49V42.46c0-2.039-.485-3.568-1.455-4.588-.926-1.063-2.513-1.595-4.762-1.595-2.073 0-3.748.398-5.027 1.196a11.685 11.685 0 0 0-3.307 3.125l-5.357-4.787c1.146-1.95 2.932-3.546 5.357-4.787 2.469-1.286 5.622-1.928 9.458-1.928 4.674 0 8.312 1.086 10.913 3.258 2.646 2.127 3.969 5.363 3.969 9.707v15.027h3.77v7.114h-5.622Zm-14.088-5.651c1.72 0 3.175-.422 4.365-1.264 1.191-.842 1.786-2.06 1.786-3.657v-4.122h-5.225c-4.013 0-6.019 1.352-6.019 4.056v1.33c0 1.196.463 2.105 1.389 2.726.926.62 2.161.93 3.704.93ZM372.452 64.202c-3.527 0-6.151-.93-7.87-2.792-1.72-1.862-2.58-4.234-2.58-7.115V37.54h-9.259v-7.646h6.018c1.456 0 2.492-.288 3.109-.865.617-.576.926-1.64.926-3.191v-8.045h8.995v12.1h13.294v7.647h-13.294v19.016h13.294v7.646h-12.633ZM410.391 65c-5.732 0-10.075-1.596-13.03-4.787-2.954-3.192-4.431-7.536-4.431-13.032 0-2.793.375-5.297 1.124-7.513.794-2.261 1.896-4.167 3.307-5.718a13.825 13.825 0 0 1 5.225-3.591c2.073-.842 4.388-1.263 6.945-1.263 2.558 0 4.85.42 6.879 1.263 2.028.798 3.748 1.95 5.159 3.457 1.411 1.508 2.491 3.347 3.24 5.52.794 2.127 1.191 4.52 1.191 7.18v2.925h-23.347v.599c0 2.216.683 4.011 2.05 5.386 1.367 1.33 3.373 1.994 6.019 1.994 2.028 0 3.77-.377 5.225-1.13a12.843 12.843 0 0 0 3.77-3.125l5.291 5.785c-1.323 1.64-3.175 3.058-5.556 4.255-2.381 1.197-5.401 1.795-9.061 1.795Zm-.794-28.856c-2.116 0-3.814.665-5.093 1.994-1.234 1.286-1.851 3.037-1.851 5.253v.532h13.757v-.532c0-2.26-.618-4.034-1.852-5.32-1.191-1.285-2.844-1.927-4.961-1.927Z" fill="currentColor" />
      </svg>

      <a href='https://github.com/zaknesler/modulate/releases/tag/v{{ env!("CARGO_PKG_VERSION") }}' target="_blank" rel="noreferrer">v{{ env!("CARGO_PKG_VERSION") }}</a>
    </header>

    <p>
      Hello, <strong>{{ name }}</strong>.

      {% if watchers.is_empty() %}
        You don't have any watchers configured for your account. Create one below to get started.
      {% else %}
        You currently have <strong>{{ watchers.len() }}</strong> {% if watchers.len() == 1 %}watcher{% else %}watchers{% endif %} configured.

        {% if crate::CONFIG.sync.enabled %}
          Tracks are set to transfer every {{ crate::CONFIG.sync.interval_mins }} minutes.
        {% endif %}
      {% endif %}
    </p>

    {% if !crate::CONFIG.sync.enabled %}
      <p>Syncing is currently disabled.</p>
    {% endif %}
  </section>
{% endmacro %}

{% macro create_section() %}
  <section>
    <h3>Create watcher</h3>
    <form class="items" id="create">
      <div class="item">
        <label for="input-playlist-from">From playlist</label>
        <select id="input-playlist-from" onchange="playlistUpdated()">
          <option value="{{ crate::model::playlist::LIKED_PLAYLIST_VALUE }}" selected>
            {{ crate::model::playlist::PlaylistType::Saved.to_string() }}
          </option>

          {% for playlist in playlists %}
            <option value="{{ playlist.id }}">{{ playlist.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="item">
        <label for="input-playlist-to">To playlist</label>
        <select id="input-playlist-to" onchange="playlistUpdated()">
          <option value="" disabled selected hidden>Select a playlist...</option>

          {% for playlist in playlists %}
            <option value="{{ playlist.id }}">{{ playlist.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="item checkbox">
        <input type="checkbox" id="checkbox-should-remove" checked />
        <label for="checkbox-should-remove">After syncing, remove transferred tracks from original playlist</label>
      </div>

      <button id="submit" class="button" disabled>Create watcher</button>
    </form>
  </section>
{% endmacro %}

{% macro watchers_section() %}
  <section>
    <h3>Your watchers</h3>
    <div class="watchers">
      {% for watcher in watchers %}
        {% let (from_data, to_data) = Self::get_mapped_display_data(self, watcher) %}
        <div class="watcher">
          <h4>
            {% call playlist_item(from_data) %}
            <small>&rarr;</small>
            {% call playlist_item(to_data) %}
          </h4>

          <small>Tracks will {% if !watcher.should_remove %}<strong>not</strong>{% endif %} be removed after syncing.</small>

          <div class="split">
            <button class="button sm" {% if !crate::CONFIG.sync.enabled %}disabled{% endif %} onclick="syncWatcher('{{ watcher.id }}')">Sync now</button>
            <button class="button sm" onclick="deleteWatcher('{{ watcher.id }}')">Remove watcher</button>
          </div>
        </div>
      {% endfor %}
    </div>
  </section>
{% endmacro %}

{% macro data_section() %}
  <section class="left">
    <h3>Your data</h3>
    <small>Playlist and user data supplied by Spotify. This app is not affiliated with nor endorsed by Spotify in any way.</small>
    <small>Click the link below to delete your connected data and watchers. Your Spotify account will be untouched, and you can always reconnect later.</small>
    <button class="link sm" onclick="deleteUser()">Delete your data</button>
  </section>
{% endmacro %}

{% macro playlist_item(playlist) %}
  {% match playlist %}
    {% when Some with (data) %}
    <a href="{{ data.spotify_url }}" target="_blank" rel="noreferrer">
      {% match data.image_url %}
        {% when Some with (image_url) %}
        <img src="{{ image_url }}" alt="{{ data.display_name }}" />

        {% when None %}
        {% match data.kind %}
          {% when crate::model::playlist::PlaylistType::Saved %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.162-.682 22.045 22.045 0 01-2.582-1.9C4.045 12.733 2 10.352 2 7.5a4.5 4.5 0 018-2.828A4.5 4.5 0 0118 7.5c0 2.852-2.044 5.233-3.885 6.82a22.049 22.049 0 01-3.744 2.582l-.019.01-.005.003h-.002a.739.739 0 01-.69.001l-.002-.001z" />
          </svg>

          {% else %}
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M17.721 1.599a.75.75 0 01.279.584v11.29a2.25 2.25 0 01-1.774 2.198l-2.041.442a2.216 2.216 0 01-.938-4.333l2.662-.576a.75.75 0 00.591-.734V6.112l-8 1.73v7.684a2.25 2.25 0 01-1.774 2.2l-2.042.44a2.216 2.216 0 11-.935-4.33l2.659-.574A.75.75 0 007 12.53V4.237a.75.75 0 01.591-.733l9.5-2.054a.75.75 0 01.63.149z" clip-rule="evenodd" />
          </svg>
        {% endmatch %}
      {% endmatch %}

      {{ data.display_name }}
    </a>

    {% when None %}
    (Unknown playlist)
  {% endmatch %}
{% endmacro %}

{% block content %}
  <div class="sections">
    {% call header_section() %}

    <section class="errors hidden" id="errors">
      <p><strong>Error:</strong> <span id="errors-text"></span></p>
    </section>

    <div class="separator"></div>

    {% call create_section() %}

    {% if !watchers.is_empty() %}
      <div class="separator"></div>
      {% call watchers_section() %}
    {% endif %}

    <div class="separator"></div>
    {% call data_section() %}
  </div>
{% endblock content %}

{% block script %}
  <script>
    const headers = {
      'Accept': 'application/json',
      'Content-Type': 'application/json',
    };

    /** @param {string} message */
    function setError(message) {
      document.querySelector('#errors-text').innerHTML = message;
      document.querySelector('#errors').classList.remove('hidden');
    }

    function clearErrors(message) {
      document.querySelector('#errors-text').innerHTML = null;
      document.querySelector('#errors').classList.add('hidden');
    }

    function refresh() {
      // Refresh window to avoid having to do state management. It's just not worth using a JS library for this lol
      window.location.reload();
    }

    function playlistUpdated(e) {
      const from = document.querySelector("#input-playlist-from").value;
      const to = document.querySelector("#input-playlist-to").value;
      document.querySelector("#submit").disabled = !from || !to || from === to;
    }

    async function deleteUser() {
      if (!confirm('Are you sure? This will delete your connected data and watchers. Your Spotify account will be untouched, and you can always reconnect later')) {
        return;
      }

      clearErrors()
      const res = await fetch("/me", { method: 'DELETE', headers });
      const data = await res.json();
      if (!data.success) return setError(data.error);

      window.location.href = "/";
    }

    /** @param {string} id */
    async function deleteWatcher(id) {
      clearErrors()
      const res = await fetch(`/watchers/${id}`, { method: 'DELETE', headers });
      const data = await res.json();
      if (!data.success) return setError(data.error);

      refresh();
    }

    /** @param {string} id */
    async function syncWatcher(id) {
      clearErrors()
      const res = await fetch(`/watchers/${id}/sync`, { method: 'POST', headers });
      const data = await res.json();
      if (!data.success) return setError(data.error);

      refresh();
    }

    document.querySelector("form#create").addEventListener('submit', async function (e) {
      clearErrors()
      e.preventDefault();

      const playlist_from = document.querySelector("#input-playlist-from").value;
      const playlist_to = document.querySelector("#input-playlist-to").value;
      const should_remove = document.querySelector("#checkbox-should-remove").checked;

      const res = await fetch("/watchers", {
        method: 'POST',
        headers,
        body: JSON.stringify({ playlist_from, playlist_to, should_remove }),
      });

      const data = await res.json();
      if (!data.success) return setError(data.error);

      refresh();
    }, true);
  </script>
{% endblock script %}
